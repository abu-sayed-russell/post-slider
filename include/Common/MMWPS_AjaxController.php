<?php/** * @package  PostSlider * @developer  name : Abu Sayed Russell */namespace MMWPS\Common;if (!class_exists('MMWPS_AjaxController')) {        class MMWPS_AjaxController {        public $created_time;        public function mmwps_register() {            $this->created_time = current_time( 'mysql' );            add_action( 'wp_ajax_mmwps_slider_action', array( $this, 'mmwps_slider_ajax_handler' ) );        }        public function mmwps_slider_ajax_handler() {        global $wpdb;        $getParam = isset( $_POST['param'] ) ? $_POST['param'] : '';        if ( ! empty( sanitize_text_field($getParam) ) ) {            if ( $getParam == "save_slider" ) {                //Query                $slider_name                        = sanitize_text_field($_POST[MMWPS_PREFIX.'slider_name'] );                $select_posts_type                  = sanitize_text_field($_POST[MMWPS_PREFIX.'select_posts_type'] );                $posts_select_date                  = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_select_date'] );                $posts_orderby                      = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_orderby'] );                $posts_order                        = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_order'] );                $per_page                           = sanitize_text_field($_POST[MMWPS_PREFIX.'per_page'] );                $ignore_sticky_posts                = sanitize_text_field($_POST[MMWPS_PREFIX.'ignore_sticky_posts'] );                $posts_status                       = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_status'] );                $select_posts                       = isset($_POST['select_posts']) && !empty($_POST['select_posts']) ? $_POST['select_posts'] : 'by_id_post';                //Layout                $skin                               = sanitize_text_field($_POST[MMWPS_PREFIX.'skin'] );                $column                             = sanitize_text_field($_POST[MMWPS_PREFIX.'column'] );                $image_position                     = sanitize_text_field($_POST[MMWPS_PREFIX.'image_position'] );                $image_size                         = sanitize_text_field($_POST[MMWPS_PREFIX.'image_size'] );                $show_image                         = sanitize_text_field($_POST[MMWPS_PREFIX.'show_image'] );                $image_width                        = sanitize_text_field($_POST[MMWPS_PREFIX.'image_width'] );                $show_title                         = sanitize_text_field($_POST[MMWPS_PREFIX.'show_title'] );                $title_tag                          = sanitize_text_field($_POST[MMWPS_PREFIX.'title_tag'] );                $show_excerpt                       = sanitize_text_field($_POST[MMWPS_PREFIX.'show_excerpt'] );                $excerpt_length                     = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_length'] );                $show_read_more                     = sanitize_text_field($_POST[MMWPS_PREFIX.'show_read_more'] );                $read_more_text                     = sanitize_text_field($_POST[MMWPS_PREFIX.'read_more_text'] );                $navigation                         = sanitize_text_field($_POST[MMWPS_PREFIX.'navigation'] );                $autoplay                           = sanitize_text_field($_POST[MMWPS_PREFIX.'autoplay'] );                $autoplay_speed                     = sanitize_text_field($_POST[MMWPS_PREFIX.'autoplay_speed'] );                //Style                $title_color                        = sanitize_text_field($_POST[MMWPS_PREFIX.'title_color'] );                $title_font_size                    = sanitize_text_field($_POST[MMWPS_PREFIX.'title_font_size'] );                $title_font_size_unit               = sanitize_text_field($_POST[MMWPS_PREFIX.'title_font_size_unit'] );                $excerpt_color                      = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_color'] );                $excerpt_font_size                  = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_font_size'] );                $excerpt_font_size_unit             = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_font_size_unit'] );                $item_bg                            = sanitize_text_field($_POST[MMWPS_PREFIX.'item_bg'] );                $item_margin_unit                   = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_unit'] );                $item_margin_top                    = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_top'] );                $item_margin_right                  = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_right'] );                $item_margin_bottom                 = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_bottom'] );                $item_margin_left                   = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_left'] );                $item_padding_unit                  = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_unit'] );                $item_padding_top                   = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_top'] );                $item_padding_right                 = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_right'] );                $item_padding_bottom                = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_bottom'] );                $item_padding_left                  = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_left'] );                //check existing                 $check_existing = mmwps_check_duplicate(mmwps_post_table(),'post_title',strtolower($slider_name));                if ( $check_existing != false) {                    echo json_encode( array( "status" => 3, "error" => 'ooh! already exits' ) );                    exit();                }else{                $save_array = array(                '_mmwps_query' =>                    array(                        '_type'                 => $select_posts_type,                        '_by_date'              => $posts_select_date,                        '_orderby'              => $posts_orderby,                        '_order'                => $posts_order,                        '_limit'                => $per_page,                        '_sticky'               => $ignore_sticky_posts,                        '_status'               => $posts_status,                        '_by_manual'            => $select_posts_type == 'by_id' ? array($select_posts) : $select_posts,                    ),                '_mmwps_layout' =>                    array(                        '_skin'                 => $skin,                        '_column'               => $column,                        '_thumb_position'       => $image_position,                        '_thumb_size'           => $image_size,                        '_show_thumb'           => $show_image,                        '_thumb_width'          => $image_width,                        '_show_title'           => $show_title,                        '_title_tag'            => $title_tag,                        '_show_excerpt'         => $show_excerpt,                        '_excerpt_length'       => $excerpt_length,                        '_show_read_more'       => $show_read_more,                        '_read_more_text'       => $read_more_text,                        '_navigation'           => $navigation,                        '_autoplay'             => $autoplay,                        '_autoplay_speed'       => $autoplay_speed,                    ),                '_mmwps_css' =>                    array(                       '_title_color'           => $title_color,                        '_title_font_size'      => $title_font_size,                        '_title_unit'           => $title_font_size_unit,                        '_excerpt_color'        => $excerpt_color,                        '_excerpt_font_size'    => $excerpt_font_size,                        '_excerpt_unit'         => $excerpt_font_size_unit,                        '_item_bg'              => $item_bg,                        '_item_margin'          => array(                            '_top'      => $item_margin_top,                            '_right'    => $item_margin_right,                            '_bottom'   => $item_margin_bottom,                            '_left'     => $item_margin_left,                        ),                        '_margin_unit'          => $item_margin_unit,                        '_item_padding'         => array(                            '_top'      => $item_padding_top,                            '_right'    => $item_padding_right,                            '_bottom'   => $item_padding_bottom,                            '_left'     => $item_padding_left,                        ),                        '_padding_unit'         => $item_padding_unit,                    ),                );                $args = array(                  'post_title'      => $slider_name,                  'post_content'    => '<!-- Created With MMWPS -->',                  'post_excerpt'    => '<!-- Created With MMWPS -->',                  'post_type'       => 'mmwps',                  'post_author'     => get_current_user_id(),                  'post_status'     => 1,                  'post_date'       => $this->created_time,                  'post_modified'   => null,                  'meta_input' 		=> array(                 	'mmwps_data' => serialize($save_array)                 ),                );                                $nonce = $_REQUEST['security'];                    if (! wp_verify_nonce($nonce, 'slider_form_nonce') ){                        echo json_encode( array( "status" => -1, "error" => "Nonce is invalid!" ) );                    }else{                        $save_slider = wp_insert_post($args);                        if ( $save_slider !== 0 ) {                            echo json_encode( array( "status" => 1, "msg" =>  "Slider Successfully Saved" ) );                             exit();                        } else {                            echo json_encode( array( "status" => 2, "error" => "Something wrong, try again!" ) );                             exit();                        }                    }                }            }elseif ( $getParam == "update_slider" ) {                //Query                $slider_name                        = sanitize_text_field($_POST[MMWPS_PREFIX.'slider_name'] );                $select_posts_type                  = sanitize_text_field($_POST[MMWPS_PREFIX.'select_posts_type'] );                $posts_select_date                  = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_select_date'] );                $posts_orderby                      = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_orderby'] );                $posts_order                        = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_order'] );                $per_page                           = sanitize_text_field($_POST[MMWPS_PREFIX.'per_page'] );                $ignore_sticky_posts                = sanitize_text_field($_POST[MMWPS_PREFIX.'ignore_sticky_posts'] );                $posts_status                       = sanitize_text_field($_POST[MMWPS_PREFIX.'posts_status'] );                $slider_status                      = sanitize_text_field($_POST['slider_slider_status'] );                $select_posts                       = isset($_POST['select_posts']) && !empty($_POST['select_posts']) ? $_POST['select_posts'] : 'by_id_post';                //Layout                $skin                               = sanitize_text_field($_POST[MMWPS_PREFIX.'skin'] );                $column                             = sanitize_text_field($_POST[MMWPS_PREFIX.'column'] );                $image_position                     = sanitize_text_field($_POST[MMWPS_PREFIX.'image_position'] );                $image_size                         = sanitize_text_field($_POST[MMWPS_PREFIX.'image_size'] );                $show_image                         = sanitize_text_field($_POST[MMWPS_PREFIX.'show_image'] );                $image_width                        = sanitize_text_field($_POST[MMWPS_PREFIX.'image_width'] );                $show_title                         = sanitize_text_field($_POST[MMWPS_PREFIX.'show_title'] );                $title_tag                          = sanitize_text_field($_POST[MMWPS_PREFIX.'title_tag'] );                $show_excerpt                       = sanitize_text_field($_POST[MMWPS_PREFIX.'show_excerpt'] );                $excerpt_length                     = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_length'] );                $show_read_more                     = sanitize_text_field($_POST[MMWPS_PREFIX.'show_read_more'] );                $read_more_text                     = sanitize_text_field($_POST[MMWPS_PREFIX.'read_more_text'] );                $navigation                         = sanitize_text_field($_POST[MMWPS_PREFIX.'navigation'] );                $autoplay                           = sanitize_text_field($_POST[MMWPS_PREFIX.'autoplay'] );                $autoplay_speed                     = sanitize_text_field($_POST[MMWPS_PREFIX.'autoplay_speed'] );                //Style                $title_color                        = sanitize_text_field($_POST[MMWPS_PREFIX.'title_color'] );                $title_font_size                    = sanitize_text_field($_POST[MMWPS_PREFIX.'title_font_size'] );                $title_font_size_unit               = sanitize_text_field($_POST[MMWPS_PREFIX.'title_font_size_unit'] );                $excerpt_color                      = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_color'] );                $excerpt_font_size                  = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_font_size'] );                $excerpt_font_size_unit             = sanitize_text_field($_POST[MMWPS_PREFIX.'excerpt_font_size_unit'] );                $item_bg                            = sanitize_text_field($_POST[MMWPS_PREFIX.'item_bg'] );                $item_margin_unit                   = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_unit'] );                $item_margin_top                    = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_top'] );                $item_margin_right                  = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_right'] );                $item_margin_bottom                 = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_bottom'] );                $item_margin_left                   = sanitize_text_field($_POST[MMWPS_PREFIX.'item_margin_left'] );                $item_padding_unit                  = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_unit'] );                $item_padding_top                   = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_top'] );                $item_padding_right                 = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_right'] );                $item_padding_bottom                = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_bottom'] );                $item_padding_left                  = sanitize_text_field($_POST[MMWPS_PREFIX.'item_padding_left'] );                //check existing                $check_existing = mmwps_check_duplicate(mmwps_post_table(),'post_title',$slider_name);                if ( count($check_existing) > 1 ) {                    echo json_encode( array( "status" => 3, "error" => "ooh! already exits" ) );                    exit();                }else{                $update_array = array(                '_mmwps_query' =>                    array(                        '_type'                 => $select_posts_type,                        '_by_date'              => $posts_select_date,                        '_orderby'              => $posts_orderby,                        '_order'                => $posts_order,                        '_limit'                => $per_page,                        '_sticky'               => $ignore_sticky_posts,                        '_status'               => $posts_status,                       '_by_manual'             => $select_posts_type == 'by_id' ? array($select_posts) : $select_posts,                    ),                '_mmwps_layout' =>                    array(                        '_skin'                 => $skin,                        '_column'               => $column,                        '_thumb_position'       => $image_position,                        '_thumb_size'           => $image_size,                        '_show_thumb'           => $show_image,                        '_thumb_width'          => $image_width,                        '_show_title'           => $show_title,                        '_title_tag'            => $title_tag,                        '_show_excerpt'         => $show_excerpt,                        '_excerpt_length'       => $excerpt_length,                        '_show_read_more'       => $show_read_more,                        '_read_more_text'       => $read_more_text,                        '_navigation'           => $navigation,                        '_autoplay'             => $autoplay,                        '_autoplay_speed'       => $autoplay_speed,                    ),                '_mmwps_css' =>                    array(                       '_title_color'           => $title_color,                        '_title_font_size'      => $title_font_size,                        '_title_unit'           => $title_font_size_unit,                        '_excerpt_color'        => $excerpt_color,                        '_excerpt_font_size'    => $excerpt_font_size,                        '_excerpt_unit'         => $excerpt_font_size_unit,                        '_item_bg'              => $item_bg,                        '_item_margin'          => array(                            '_top'      => $item_margin_top,                            '_right'    => $item_margin_right,                            '_bottom'   => $item_margin_bottom,                            '_left'     => $item_margin_left,                        ),                        '_margin_unit'          => $item_margin_unit,                        '_item_padding'         => array(                            '_top'      => $item_padding_top,                            '_right'    => $item_padding_right,                            '_bottom'   => $item_padding_bottom,                            '_left'     => $item_padding_left,                        ),                        '_padding_unit'         => $item_padding_unit,                    ),                );                $args = array(                  'ID'              => intval($_POST['slider_edit_id']),                  'post_title'      => $slider_name,                  'post_content'    => '<!-- Created With MMWPS -->',                  'post_excerpt'    => '<!-- Created With MMWPS -->',                  'post_type'       => 'mmwps',                  'post_author'     => get_current_user_id(),                  'post_status'     => $slider_status,                  'post_date'       => $this->created_time,                  'post_modified'   => null,                );                                                $nonce = $_REQUEST['update_security'];                if (! wp_verify_nonce($nonce, 'slider_edit_form_nonce') ){                    echo json_encode( array( "status" => -1, "error" => "Nonce is invalid!" ) );                   }else{                    $update_slider = wp_update_post( $args );                    if ( $update_slider !== 0 ) {                        update_post_meta( intval($_POST['slider_edit_id']), 'mmwps_data', serialize($update_array) );                        echo json_encode( array( "status" => 1, "msg" => "Slider Successfully Updated" ) );                         exit();                    } else {                        echo json_encode( array( "status" => 2, "error" => "Something wrong, try again!" ) );                         exit();                    }                }            }            }elseif ( $getParam == "status_slider_deactive" ) {                $permission = check_ajax_referer( 'slider_status_nonce', 'nonce', false );                if( $permission == false ) {                    echo json_encode( array( "status" => -1, "msg" => "Something wrong, try again!" ) );                    }else{                    $update_status  = $wpdb->update( mmwps_post_table(), array(                        "post_status"      => 0,                    ), array(                        "ID" => intval($_POST['id']),                    ) );                    if ( $update_status == 1 ) {                        echo json_encode( array( "status" => 1, "msg" => "Status has been successfully changed" ) );                    } else {                        echo json_encode( array( "status" => 2, "error" => "Something wrong, try again!" ) );                    }                }            }elseif ( $getParam == "status_slider_active" ) {                $permission = check_ajax_referer( 'slider_status_nonce', 'nonce', false );                if( $permission == false ) {                    echo json_encode( array( "status" => -1, "msg" => "Something wrong, try again!" ) );                    }else{                    $update_status  = $wpdb->update( mmwps_post_table(), array(                        "post_status"      => 1,                    ), array(                        "ID" => intval($_POST['id']),                    ) );                    if ( $update_status == 1 ) {                        echo json_encode( array( "status" => 1, "msg" => "Status has been successfully changed" ) );                    } else {                        echo json_encode( array( "status" => 2, "error" => "Something wrong, try again!" ) );                    }                }            } elseif ( $getParam == "delete_slider" ) {                $permission = check_ajax_referer( 'delete_slider_nonce', 'nonce', false );                    if( $permission == false ) {                            echo json_encode( array( "status" => -1, "msg" => "Something wrong, try again!" ) );                        }else{                            $delete = $wpdb->delete( mmwps_post_table(), array(                                "ID" => intval($_REQUEST['id']),                            ) );                            if ( $delete ) {                                $wpdb->delete( mmwps_post_meta_table(), array(                                    "post_id" => intval($_REQUEST['id']),                                ) );                            }                        echo json_encode( array( "status" => 1, "msg" => "Slider has been successfully deleted." ) );                    }                    die();            }        }        wp_die();        }    }}